import{a as X,b as Y}from"./chunk-ZYZ7D5RS.js";import{a as J}from"./chunk-DZQGWMRM.js";import"./chunk-ELXQ6ALC.js";import{d as z,e as K}from"./chunk-PZXQOTNQ.js";import{a as Q,b as W}from"./chunk-SUQYPSBK.js";import{b as a}from"./chunk-U5YLW2ZZ.js";import"./chunk-X3M3N6ZJ.js";import{e as k,g as G}from"./chunk-RFCIZRZT.js";import{f as M}from"./chunk-5LHHFRH4.js";import{j as D,m as H}from"./chunk-FTR46PKS.js";import{$b as A,Cb as h,E as T,Eb as R,Fb as q,Gb as L,Gc as N,Hb as s,I as b,Ib as n,Kb as I,La as _,Ob as O,Pb as l,Za as p,Zb as d,_b as g,aa as U,cb as c,ea as B,fc as v,gc as f,ib as V,ja as j,l as E,nb as u,r as m,v as P,va as x,vc as F,wa as y,yb as C}from"./chunk-LZBM4COA.js";var $=a.object({_id:a.string().optional(),user:a.string(),products:a.array(a.object({productId:a.string(),quantity:a.number(),price:a.number()})),shippingAddress:a.string(),paymentMethod:a.string(),shippingCost:a.number(),totalPrice:a.number(),status:a.enum(["pending","processing","shipped","delivered","cancelled"])}),Z=a.array($);var ee={BACK_URL:"http://localhost:3000/api"};var w=class i{constructor(t,e){this.http=t;this.store=e}baseUrl=`${ee.BACK_URL}/orders`;ordersSubject=new E([]);$order=this.ordersSubject.asObservable();lastOrderSubject=new E(null);lastOrder$=this.lastOrderSubject.asObservable();getUserId(){let t="";return this.store.select(k).pipe(b(1)).subscribe({next:e=>t=e??""}),t}loadOrders(){this.getUserId()}getOrdersByUserId(t){return this.http.get(`${this.baseUrl}/${t}`).pipe(P(e=>{console.log(e);let o=Z.safeParse(e);if(!o.success)throw new Error(`Order validation failed: ${o.error}`);return o.data}),T(e=>e.status===404?m([]):(console.log("Error fetching order",e),m([]))))}createOrder(t){return this.http.post(`${this.baseUrl}`,t).pipe(P(e=>{let o=$.safeParse(e);return o.success?(this.lastOrderSubject.next(o.data),[...this.ordersSubject.value??[],o.data]):(console.log(o.error),[])}),U(e=>{this.ordersSubject.next(e)}))}static \u0275fac=function(e){return new(e||i)(j(N),j(M))};static \u0275prov=B({token:i,factory:i.\u0275fac,providedIn:"root"})};function oe(i,t){if(i&1){let e=I();s(0,"app-payment-methods-list",15),O("select",function(r){x(e);let S=l(2);return y(S.onPaymentMethodSelected(r))}),n()}if(i&2){let e=l(2);C("paymentMethods",t)("isSelectable",!0)("selectedId",e.paymentMethodId||null)}}function se(i,t){if(i&1){let e=I();s(0,"app-shipping-methods-list",16),O("select",function(r){x(e);let S=l(2);return y(S.onShippingAddressSelected(r))}),n()}if(i&2){let e=l(2);C("shippingMethods",t)("isSelectable",!0)("selectedId",e.shippingMethodId||null)}}function ae(i,t){if(i&1&&(s(0,"div",11)(1,"div",17)(2,"p",18),d(3),n(),s(4,"p",19),d(5),n()(),s(6,"div",20),d(7),v(8,"currency"),n()()),i&2){let e=t.$implicit;p(3),g(e.product.name),p(2),A("x",e.quantity,""),p(2),g(f(8,3,e.product.price*e.quantity))}}function de(i,t){if(i&1&&(s(0,"p",14),d(1),n()),i&2){let e=l(2);p(),g(e.errorMsg())}}function pe(i,t){if(i&1){let e=I();s(0,"div",2)(1,"div",4)(2,"div"),d(3," M\xE9todo de Pago "),n(),s(4,"div"),u(5,oe,1,3,"app-payment-methods-list",5),v(6,"async"),n()(),s(7,"div",4)(8,"div"),d(9," Direcci\xF3n de Envio "),n(),u(10,se,1,3,"app-shipping-methods-list",6),v(11,"async"),n(),s(12,"div",7)(13,"div",8)(14,"h2",9),d(15,"Resumen"),n(),s(16,"div",10),q(17,ae,9,5,"div",11,R),n(),s(19,"div",12)(20,"span"),d(21,"Total"),n(),s(22,"span"),d(23),v(24,"currency"),n()(),s(25,"button",13),O("click",function(){x(e);let r=l();return y(r.submitOrder())}),d(26),n(),u(27,de,2,1,"p",14),n()()()}if(i&2){let e,o,r=l();p(5),h((e=f(6,6,r.paymentMethod$))?5:-1,e),p(5),h((o=f(11,8,r.shippingAddress$))?10:-1,o),p(7),L(t.products),p(6),g(f(24,10,r.total())),p(2),C("disabled",r.loading()),p(),A(" ",r.loading()?"Procesando...":"Confirmar Pedido"," "),p(),h(r.errorMsg()?27:-1)}}function ce(i,t){i&1&&(s(0,"div",3)(1,"p",21),d(2,"No hay productos en el carrito."),n(),s(3,"a",22),d(4,"Volver al carrito"),n()())}var te=class i{constructor(t,e,o,r,S,le,me){this.paymentService=t;this.cartService=e;this.store=o;this.orderservice=r;this.router=S;this.toast=le;this.shippingAddress=me}cartSig=_(null);loading=_(!1);errorMsg=_(null);paymentMethod$=m([]);paymentMethodId="";shippingAddress$=m([]);shippingMethodId="";total=F(()=>this.cartSig()?.products.reduce((t,e)=>t+e.product.price*e.quantity,0)||0);ngOnInit(){this.getUserId()&&(this.cartService.cart$.subscribe(e=>this.cartSig.set(e)),this.paymentService.loadPayMethods(),this.paymentMethod$=this.paymentService.paymetMethods$,this.shippingAddress.loadShippingAddresses(),this.shippingAddress$=this.shippingAddress.shippingAddresses$)}onPaymentMethodSelected(t){this.paymentMethodId=t}onShippingAddressSelected(t){this.shippingMethodId=t}submitOrder(){let t=this.cartSig(),e=this.getUserId();if(!t||!e)return;this.loading.set(!0);let o={user:e,products:t.products.map(r=>({productId:r.product._id,quantity:r.quantity,price:r.product.price})),totalPrice:this.total(),status:"pending",shippingAddress:this.shippingMethodId,paymentMethod:this.paymentMethodId,shippingCost:0};this.orderservice.createOrder(o).subscribe({next:()=>{this.cartService.clearCart().subscribe(()=>{this.cartSig.set(null),this.loading.set(!1),this.router.navigateByUrl("/thank-you-page")})},error:r=>{this.loading.set(!1),console.log(r),this.errorMsg.set("There was an error processing your order. Please try again.")}})}getUserId(){let t="";return this.store.select(k).pipe(b(1)).subscribe(e=>t=e??""),t}static \u0275fac=function(e){return new(e||i)(c(W),c(J),c(M),c(w),c(z),c(G),c(Y))};static \u0275cmp=V({type:i,selectors:[["app-check-out"]],decls:5,vars:1,consts:[[1,"max-w-6xl","mx-auto","py-8","px-4"],[1,"text-3xl","font-bold","mb-6","text-center"],[1,"grid","grid-cols-1","lg:grid-cols-3","gap-8"],[1,"text-center","py-20"],[1,"lg:col-span-2","space-y-6"],[3,"paymentMethods","isSelectable","selectedId"],[3,"shippingMethods","isSelectable","selectedId"],[1,"space-y-6"],[1,"bg-white","shadow","rounded-lg","p-6"],[1,"text-xl","font-semibold","mb-4"],[1,"divide-y"],[1,"py-2","flex","items-center","justify-between","text-sm"],[1,"border-t","mt-4","pt-4","flex","justify-between","font-bold","text-legt"],[1,"w-full","mt-4","bg-blue-600","text-white","text-3xl","hover:bg-green-700","rounded-lg","py-3","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"text-red-600","text-sm","mt-2"],[3,"select","paymentMethods","isSelectable","selectedId"],[3,"select","shippingMethods","isSelectable","selectedId"],[1,"flex-1","pr-2"],[1,"font-medium","line-clamp-1"],[1,"text-gray-500"],[1,"font-semibold"],[1,"text-gray-600","mb-4"],["routerLink","/user/cart",1,"inline-block","bg-blue-600","text-white","px-6","py-3","rounded","hover:bg-blue-700"]],template:function(e,o){if(e&1&&(s(0,"div",0)(1,"h1",1),d(2,"Confirmaci\xF3n del Pedido"),n(),u(3,pe,28,12,"div",2)(4,ce,5,0,"div",3),n()),e&2){let r;p(3),h((r=o.cartSig())?3:4,r)}},dependencies:[Q,K,H,D,X],encapsulation:2})};export{te as CheckOutComponent};
