import{a as S}from"./chunk-ELXQ6ALC.js";import{a as s,b as o}from"./chunk-U5YLW2ZZ.js";import{e as y,g as j}from"./chunk-RFCIZRZT.js";import{f as v}from"./chunk-5LHHFRH4.js";import{E as h,Gc as C,I as g,Z as p,aa as n,ea as f,ja as c,l as b,r as i,v as a}from"./chunk-LZBM4COA.js";var U=o.object({_id:o.string(),name:o.string(),description:o.string().optional(),price:o.number(),imageUrl:o.string().optional(),stock:o.number(),category:o.string()});var m=s.object({_id:s.string(),user:S,products:s.array(s.object({product:U,quantity:s.number().min(1)}))}),B=s.array(m);var I=class u{constructor(t,r,e){this.httpClient=t;this.toast=r;this.store=e;this.loadUserCart()}baseUrl="http://localhost:3000/api/cart";cartSubject=new b(null);cart$=this.cartSubject.asObservable();getUserId(){let t="";return this.store.select(y).pipe(g(1)).subscribe({next:r=>t=r??""}),t}getCartByUserId(t){return this.httpClient.get(`${this.baseUrl}/user/${t}`).pipe(a(r=>{let e=m.safeParse(r);if(!e.success)throw console.log(e.error),new Error(`${e.error}`);return e.data}))}loadUserCart(){let t=this.getUserId();if(!t){this.cartSubject.next(null);return}this.getCartByUserId(t).subscribe({next:r=>{this.cartSubject.next(r)},error:r=>{this.cartSubject.next(null)}})}addToCart(t,r=1){let e=this.getUserId();if(!e)return console.log("usuario no autentificado"),i(null);let l={userId:e,productId:t,quantity:r};return this.httpClient.post(`${this.baseUrl}/add-product`,l).pipe(p(()=>this.getCartByUserId(e)),n(d=>{this.toast.success("Producto agregado al carrito"),this.cartSubject.next(d)}),h(d=>i(null)))}removeFromCart(t){let r=this.getUserId();if(!r)return console.log("usuario no autentificado"),i(null);let e={userId:r,productId:t};return this.httpClient.delete(`${this.baseUrl}/remove-product`,{body:e}).pipe(p(()=>this.getCartByUserId(r)),n(l=>{this.cartSubject.next(l),this.toast.success("Producto eliminado del carrito")}))}clearCart(){let t=this.cartSubject.value?._id;return t?this.httpClient.delete(`${this.baseUrl}/${t}`).pipe(n(()=>{this.cartSubject.next(null),this.toast.success("Carrito eliminado")}),a(()=>null)):i(null)}getItemCount(){return this.cart$.pipe(a(t=>!t||t.products.length===0?0:t.products.reduce((r,e)=>r+e.quantity,0)))}getCartTotal(){return this.cart$.pipe(a(t=>!t||t.products.length===0?0:t.products.reduce((r,e)=>r+e.product.price*e.quantity,0)))}static \u0275fac=function(r){return new(r||u)(c(C),c(j),c(v))};static \u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})};export{I as a};
